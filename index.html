<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="BCLogo.png">
    <meta property="og:title" content="BaghChal - Classical" />
    <meta property="og:image" content="BCLogo.png" />
    <meta property="og:description" content="Multiplayer - BaghChal Game with Classical theme." />
    <meta property="og:type" content="website" />
    <title>Bagh-Chal: Classical</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --board-size: 320px;
            --step: 80px;
            --bg-color: #e6dcc3;
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --accent-gold: #bcaaa4;
            --highlight: #d7ccc8;
            --goat-text: #2c3e50;
            --tiger-text: #c0392b;
            --line-color: #3e2723;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Playfair Display', serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#d7ccc8 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--wood-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevents scroll on desktop, handled inside screens for mobile */
        }

        /* Responsive Container */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 420px;
            padding: 20px;
            animation: fadeIn 0.4s ease;
            /* Allow scrolling on small vertical screens */
            max-height: 100vh;
            overflow-y: auto; 
        }

        .screen.active {
            display: flex;
        }

        .menu-card {
            background: #fdfbf7;
            padding: 35px;
            border-radius: 4px;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 15px rgba(62, 39, 35, 0.15);
            border: 2px solid var(--wood-dark);
            position: relative;
        }

        .menu-card::after {
            content: "";
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px solid var(--wood-light);
            pointer-events: none;
            opacity: 0.5;
        }

        h1, h2 {
            margin-top: 0;
            color: var(--wood-dark);
            letter-spacing: 1px;
        }

        .menu-btn {
            width: 100%;
            padding: 18px;
            margin: 10px 0;
            border-radius: 2px;
            background: transparent;
            border: 2px solid var(--wood-dark);
            color: var(--wood-dark);
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .menu-btn:hover {
            background: var(--wood-dark);
            color: #fdfbf7;
        }

        .menu-btn.primary {
            background: var(--wood-dark);
            color: #fdfbf7;
        }

        .menu-btn.primary:hover {
            background: var(--wood-light);
        }

        .menu-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .hud {
            width: var(--board-size);
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid var(--wood-dark);
            transition: width 0.3s;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* The Board */
        .board-wrapper {
            position: relative;
            width: calc(var(--board-size) + 40px);
            height: calc(var(--board-size) + 40px);
            background: #6d4c41;
            padding: 20px;
            border-radius: 6px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.4), 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 4px solid #3e2723;
            /* Responsive Scaling origin */
            transform-origin: center top; 
            transition: transform 0.3s;
        }

        svg {
            position: absolute;
            top: 20px;
            left: 20px;
            width: var(--board-size);
            height: var(--board-size);
            z-index: 1;
        }

        #game-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            width: var(--board-size);
            height: var(--board-size);
            z-index: 2;
        }

        .node {
            position: absolute;
            width: 64px;
            height: 64px;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            cursor: pointer;
        }

        .piece {
            font-size: 2.6rem;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.3));
        }

        .piece.selected {
            transform: scale(1.1) translateY(-5px);
        }

        .hint {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Input Styling */
        input {
            background: transparent;
            border: 2px solid var(--wood-dark);
            padding: 15px;
            width: 100%;
            color: var(--wood-dark);
            font-family: inherit;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            border-radius: 2px;
        }
        
        /* Remove spinner arrows from number input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        input::placeholder {
            color: rgba(62, 39, 35, 0.5);
        }

        #join-error {
            color: var(--tiger-text);
            font-size: 0.9rem;
            font-weight: 900;
            margin-top: 10px;
            text-transform: uppercase;
            display: none;
            animation: fadeIn 0.3s;
        }

        /* Overlays */
        #overlay,
        #disconnect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(230, 220, 195, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #overlay.show,
        #disconnect-overlay.active {
            display: flex;
        }

        .modal {
            background: #fdfbf7;
            padding: 40px;
            border: 4px double var(--wood-dark);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(62, 39, 35, 0.2);
        }

        #role-announcer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            font-weight: 900;
            font-size: 2rem;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .pulse-text {
            animation: rolePulse 2.5s forwards ease-in-out;
        }

        /* Responsive Media Queries */
        @media (max-width: 380px) {
            /* Scale the board down for small screens without changing JS logic */
            .board-wrapper {
                transform: scale(0.85);
            }
            .hud {
                width: 100%;
                transform: scale(0.95);
            }
            .menu-card {
                padding: 25px 20px;
            }
            h1 { font-size: 2.2rem !important; }
        }

        /* Handle very short screens (Landscape on mobile) */
        @media (max-height: 600px) {
            .board-wrapper {
                transform: scale(0.7);
                margin-top: -20px;
                margin-bottom: -20px;
            }
            .screen {
                justify-content: flex-start;
                padding-top: 10px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes rolePulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
        }
    </style>
</head>

<body>

    <div id="disconnect-overlay">
        <div class="modal">
            <h1 style="color:var(--tiger-text)">FRIEND DEPARTED</h1>
            <p id="reload-timer" style="font-style: italic;">Returning To Lobby in 3...</p>
        </div>
    </div>

    <div id="screen-home" class="screen active">
        <div class="menu-card">
            <h1 style="font-size: 2.8rem; margin-bottom: 10px;">BAGH CHAL</h1>
            <div style="width: 50px; height: 2px; background: var(--wood-dark); margin: 0 auto 30px;"></div>
            <button class="menu-btn primary" onclick="startLocalMultiplayer()">Offline (2P)</button>
            <button class="menu-btn" onclick="showOnlinePanel()">Online (P2P)</button>
            <button class="menu-btn" style="border:none; font-size: 0.9rem; margin-top:10px;" onclick="alert('Goats win by surrounding Tigers.\nTigers win by capturing 5 Goats.\n Note: If Online game do not Connects. Try Again after refreshing the page!')">Rules of Play</button>
        </div>
    </div>

    <div id="screen-online" class="screen">
        <div class="menu-card">
            <h2>Online Lobby</h2>
            <div id="peer-id-display" onclick="copyRoomID()" style="padding:15px; border: 1px dashed var(--wood-dark); background:rgba(0,0,0,0.03); margin:15px 0; font-family:monospace; font-size:1.4rem; cursor:pointer;" title="Click to Copy">
                Connecting...</div>

            <div id="copy-hint" style="font-size: 0.8rem; margin-top: -10px; margin-bottom: 10px; opacity: 0.6; font-style: italic; display: none;">
                Click the code to copy.
            </div>

            <div style="margin: 20px 0; font-style: italic; opacity: 0.7;">- or -</div>
            
            <input type="number" id="join-id" placeholder="Enter Friend's Code" inputmode="numeric" pattern="[0-9]*">
            
            <div id="join-error">INVALID CODE</div>

            <button class="menu-btn primary" onclick="joinRoom()" style="margin-top:15px;">Join Match</button>
            <button class="menu-btn" onclick="showScreen('home')" style="border:none;">Return</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud">
            <div id="status-label" style="font-size: 1.4rem; font-weight:900; text-transform:uppercase; letter-spacing: 1px;">Preparing...</div>
            <div class="stats-row">
                <div style="color:var(--goat-text)">Goats: <span id="g-hand">20</span></div>
                <div style="color:var(--tiger-text)">Captured: <span id="g-dead">0/5</span></div>
            </div>
        </div>

        <div class="board-wrapper">
            <div id="role-announcer"></div>
            <svg id="board-svg" viewBox="0 0 320 320"></svg>
            <div id="game-layer"></div>
        </div>

        <button class="menu-btn" onclick="quitGame()" style="margin-top:25px; border:none; font-size: 0.9rem; opacity: 0.7;">Resign Game</button>
    </div>

    <div id="overlay">
        <div class="modal">
            <h1 id="win-msg" style="font-size: 2.2rem; margin-bottom: 10px;">VICTORY</h1>
            <div style="width: 30px; height: 2px; background: var(--wood-dark); margin: 0 auto 20px;"></div>
            <p id="win-details" style="font-style: italic; margin-bottom: 20px;"></p>
            <p id="friend-status" style="color:var(--tiger-text); font-weight:bold; height:1.2rem; margin-bottom:15px;"></p>
            <button class="menu-btn primary" id="restart-btn" onclick="requestRestart()">Rematch</button>
            <button class="menu-btn" onclick="quitGame()">Main Menu</button>
        </div>
    </div>

    <script>
        const audioCtx = new(window.AudioContext || window.webkitAudioContext)();
        const STEP = 80;
        let board, turn, phase, goatsHand, goatsDead, selected, validMoves;
        let gameMode, myRole, peer, conn;
        let restartVotes = { me: false, peer: false };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('join-error').style.display = 'none';
        }

        function initGame(mode, role) {
            gameMode = mode;
            myRole = role;
            board = Array(5).fill().map(() => Array(5).fill(null));
            board[0][0] = board[0][4] = board[4][0] = board[4][4] = 'T';
            turn = 'G';
            phase = 'place';
            goatsHand = 20;
            goatsDead = 0;
            selected = null;
            validMoves = [];
            restartVotes = { me: false, peer: false };

            drawGrid();
            render();
            showScreen('game');

            const announcer = document.getElementById('role-announcer');
            if (gameMode === 'online') {
                announcer.innerText = myRole === 'G' ? 'YOU ARE GOAT ðŸ' : 'YOU ARE TIGER ðŸ¯';
                announcer.classList.remove('pulse-text');
                void announcer.offsetWidth;
                announcer.classList.add('pulse-text');
            } else {
                announcer.innerText = "LOCAL MATCH";
            }
        }

        function drawGrid() {
            const svg = document.getElementById('board-svg');
            svg.innerHTML = '';
            const lineColor = "rgba(255, 235, 205, 0.4)";

            const createLine = (x1, y1, x2, y2) => {
                const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                l.setAttribute('x1', x1);
                l.setAttribute('y1', y1);
                l.setAttribute('x2', x2);
                l.setAttribute('y2', y2);
                l.setAttribute('stroke', lineColor);
                l.setAttribute('stroke-width', '3');
                l.setAttribute('stroke-linecap', 'round');
                svg.appendChild(l);
            };

            createLine(0, 0, 320, 320);
            createLine(320, 0, 0, 320);
            createLine(160, 0, 320, 160);
            createLine(320, 160, 160, 320);
            createLine(160, 320, 0, 160);
            createLine(0, 160, 160, 0);

            for (let i = 0; i < 5; i++) {
                createLine(0, i * STEP, 320, i * STEP);
                createLine(i * STEP, 0, i * STEP, 320);
            }
        }

        function render() {
            const layer = document.getElementById('game-layer');
            layer.innerHTML = '';
            const statusLabel = document.getElementById('status-label');

            let turnText = turn === 'G' ? "Goat's Turn" : "Tiger's Turn";
            if (gameMode === 'online') {
                turnText = (turn === myRole) ? "Your Move" : "Friend's Move";
            }

            statusLabel.innerText = turnText;
            statusLabel.style.color = turn === 'G' ? 'var(--goat-text)' : 'var(--tiger-text)';
            document.getElementById('g-hand').innerText = goatsHand;
            document.getElementById('g-dead').innerText = `${goatsDead}/5`;

            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const node = document.createElement('div');
                    node.className = 'node';
                    node.style.top = (r * STEP) + 'px';
                    node.style.left = (c * STEP) + 'px';
                    const p = board[r][c];

                    if (p) {
                        const pDiv = document.createElement('div');
                        pDiv.className = 'piece' + (selected && selected.r === r && selected.c === c ? ' selected' : '');
                        pDiv.innerText = p === 'T' ? 'ðŸ¯' : 'ðŸ';
                        node.appendChild(pDiv);
                    }
                    if (gameMode === 'local' || turn === myRole) {
                        const m = validMoves.find(mv => mv.r === r && mv.c === c);
                        if (m) {
                            const h = document.createElement('div');
                            h.className = 'hint';
                            node.appendChild(h);
                        }
                    }
                    node.onclick = () => handleInput(r, c);
                    layer.appendChild(node);
                }
            }
        }

        function handleInput(r, c) {
            if (gameMode === 'online' && turn !== myRole) return;
            processMove(r, c);
        }

        function processMove(r, c, isRemote = false) {
            const p = board[r][c];
            if (gameMode === 'online' && !isRemote) conn.send({ type: 'move', r, c });

            if (turn === 'G' && phase === 'place' && !p) {
                board[r][c] = 'G';
                goatsHand--;
                if (goatsHand === 0) phase = 'move';
                playThok();
                switchTurn();
                return;
            }
            if (p === turn) {
                if (turn === 'G' && phase === 'place') return;
                selected = { r, c };
                findMoves(r, c);
                render();
                return;
            }
            if (selected) {
                const m = validMoves.find(mv => mv.r === r && mv.c === c);
                if (m) {
                    board[m.r][m.c] = board[selected.r][selected.c];
                    board[selected.r][selected.c] = null;
                    if (m.type === 'kill') {
                        board[m.kr][m.kc] = null;
                        goatsDead++;
                    }
                    playThok();
                    selected = null;
                    validMoves = [];
                    if (goatsDead >= 5) end("TIGERS TRIUMPH");
                    else switchTurn();
                } else {
                    selected = null;
                    validMoves = [];
                    render();
                }
            }
        }

        function switchTurn() {
            turn = turn === 'G' ? 'T' : 'G';
            if (turn === 'T' && checkTrap()) {
                end("GOATS TRIUMPH");
                return;
            }
            render();
        }

        function end(msg) {
            document.getElementById('overlay').classList.add('show');
            document.getElementById('win-msg').innerText = msg;
            document.getElementById('win-msg').style.color = msg.includes("GOAT") ? "var(--goat-text)" : "var(--tiger-text)";
            document.getElementById('win-details').innerText = msg.includes("GOAT") ? "The Tigers have been trapped." : "The herd has been decimated.";
            document.getElementById('restart-btn').innerText = "Rematch";
            document.getElementById('restart-btn').disabled = false;
        }

        function triggerDisconnect() {
            if (gameMode !== 'online') return;
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('disconnect-overlay').classList.add('active');
            let count = 3;
            const interval = setInterval(() => {
                count--;
                document.getElementById('reload-timer').innerText = `Returning To Lobby in ${count}...`;
                if (count <= 0) {
                    clearInterval(interval);
                    location.reload();
                }
            }, 1000);
        }

        function quitGame() {
            if (conn) {
                conn.close();
                location.reload();
            } else showScreen('home');
        }

        function requestRestart() {
            if (gameMode === 'online') {
                restartVotes.me = true;
                conn.send({ type: 'restart-vote' });
                document.getElementById('restart-btn').innerText = "Awaiting Friend...";
                document.getElementById('restart-btn').disabled = true;
                if (restartVotes.peer && (conn.peer > peer.id)) {
                    const role = Math.random() > 0.5 ? 'G' : 'T';
                    conn.send({ type: 'init', role: role === 'G' ? 'T' : 'G' });
                    initGame('online', role);
                }
            } else initGame('local', 'G');
        }

        function setupConn() {
            conn.on('open', () => {
                document.getElementById('join-error').style.display = 'none';
                if (conn.peer > peer.id) {
                    const role = Math.random() > 0.5 ? 'G' : 'T';
                    setTimeout(() => {
                        conn.send({ type: 'init', role: role === 'G' ? 'T' : 'G' });
                        initGame('online', role);
                    }, 500);
                }
            });
            conn.on('data', (data) => {
                if (data.type === 'init') initGame('online', data.role);
                if (data.type === 'move') processMove(data.r, data.c, true);
                if (data.type === 'restart-vote') {
                    restartVotes.peer = true;
                    if (!restartVotes.me) {
                        document.getElementById('friend-status').innerText = "Your Friend Wants a Rematch.";
                    }
                    if (restartVotes.me && (conn.peer > peer.id)) {
                        const role = Math.random() > 0.5 ? 'G' : 'T';
                        conn.send({ type: 'init', role: role === 'G' ? 'T' : 'G' });
                        initGame('online', role);
                    }
                }
            });
            conn.on('close', triggerDisconnect);
            conn.on('error', triggerDisconnect);
        }

        function initPeer() {
            if (peer) return;
            const randomID = Math.floor(100000 + Math.random() * 900000).toString();
            peer = new Peer(randomID);

            peer.on('open', id => {
                const display = document.getElementById('peer-id-display');
                display.innerText = id;
                document.getElementById('copy-hint').style.display = 'block';
            });

            peer.on('connection', c => {
                conn = c;
                setupConn();
            });

            peer.on('error', (err) => {
                if (err.type === 'peer-unavailable') {
                    document.getElementById('join-error').style.display = 'block';
                }
            });
        }

        function copyRoomID() {
            const display = document.getElementById('peer-id-display');
            const id = display.innerText;
            if (id === "Connecting...") return;

            navigator.clipboard.writeText(id).then(() => {
                const originalBg = display.style.background;
                display.style.background = "var(--highlight)";
                setTimeout(() => display.style.background = originalBg, 200);
            });
        }

        function joinRoom() {
            const id = document.getElementById('join-id').value;
            if (!id) return;
            document.getElementById('join-error').style.display = 'none';
            conn = peer.connect(id);
            setupConn();
        }

        function findMoves(r, c) {
            validMoves = [];
            const ds = [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]];
            ds.forEach(([dr, dc]) => {
                if ((dr !== 0 && dc !== 0) && (r + c) % 2 !== 0) return;
                const nr = r + dr, nc = c + dc;
                if (nr >= 0 && nr < 5 && nc >= 0 && nc < 5) {
                    if (!board[nr][nc]) validMoves.push({ r: nr, c: nc, type: 'move' });
                    else if (turn === 'T' && board[nr][nc] === 'G') {
                        const jr = nr + dr, jc = nc + dc;
                        if (jr >= 0 && jr < 5 && jc >= 0 && jc < 5 && !board[jr][jc])
                            validMoves.push({ r: jr, c: jc, type: 'kill', kr: nr, kc: nc });
                    }
                }
            });
        }

        function checkTrap() {
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    if (board[r][c] === 'T') {
                        const ds = [[-1, 0], [1, 0], [0, -1], [0, 1], [-1, -1], [-1, 1], [1, -1], [1, 1]];
                        for (let [dr, dc] of ds) {
                            if ((dr !== 0 && dc !== 0) && (r + c) % 2 !== 0) continue;
                            const nr = r + dr, nc = c + dc;
                            if (nr >= 0 && nr < 5 && nc >= 0 && nc < 5) {
                                if (!board[nr][nc]) return false;
                                const jr = nr + dr, jc = nc + dc;
                                if (board[nr][nc] === 'G' && jr >= 0 && jr < 5 && jc >= 0 && jc < 5 && !board[jr][jc])
                                    return false;
                            }
                        }
                    }
                }
            }
            return true;
        }

        function playThok() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.type = 'triangle';
            osc1.frequency.setValueAtTime(150, now);
            osc1.frequency.exponentialRampToValueAtTime(10, now + 0.05);
            gain1.gain.setValueAtTime(1.0, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(80, now);
            gain2.gain.setValueAtTime(1.0, now);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc1.start(now);
            osc1.stop(now + 0.05);
            osc2.start(now);
            osc2.stop(now + 0.15);
        }

        function startLocalMultiplayer() { initGame('local', 'G'); }
        function showOnlinePanel() { showScreen('online'); initPeer(); }
    </script>
</body>
</html>
